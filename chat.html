<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/8595/8595483.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boredom Hub - Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" target="_blank">Home</a>
        <a href="games.html" target="_blank">Games</a>
        <a href="about.html" target="_blank">About Us</a>
        <a href="contact.html" target="_blank">Contact</a>   
        <a href="chat.html" target="_blank">Chat</a>
        <a href="rabbitAI.html" target="_blank">rabbitAI calculator</a>
    </div>
    <div class="content">
        <h2>Chat Room</h2>
        <p id="authStatus">Not logged in</p>
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()">Sign Out</button>
        <br><br>
        <input type="text" id="usernameInput" placeholder="Enter Username">
        <input type="text" id="messageInput" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
        <div id="chatBox" class="chat-box" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

<script>
    const ably = new Ably.Realtime("mGqA8g.tKm8cg:BXet5NQMtxfr8k8I4Ls0MEzeQxmsQHihc80xDsYd-Ko");
    const channel = ably.channels.get("chat-room");

    let mutedUsers = {}; 
    const modEmails = ["872654@dpsk12.net", "878197@dpsk12.net", "871341@dpsk12.net"];
    const devEmails = ["866537@dpsk12.net", "871491@dpsk12.net"];
    const headDevEmail = "856030@dpsk12.net";

    function signIn() {
        const email = prompt("Enter your email:");
        const username = prompt("Enter your username:");

        if (!email || !username) {
            alert("Email and username are required!");
            return;
        }

        sessionStorage.setItem("userEmail", email);
        sessionStorage.setItem("username", username);
        document.getElementById("authStatus").innerText = `Logged in as ${email}`;
    }

    function sendMessage() {
        const messageInput = document.getElementById("messageInput").value.trim();
        const email = sessionStorage.getItem("userEmail");
        const username = sessionStorage.getItem("username");

        if (!email || !username) {
            alert("You must be signed in to send messages.");
            return;
        }

        if (mutedUsers[email]) {
            alert("You are muted and cannot send messages.");
            return;
        }

        if (messageInput.startsWith("/mute")) {
            handleMuteCommand(messageInput);
            return;
        }
        if (messageInput.startsWith("/unmute")) {
            handleUnmuteCommand(messageInput);
            return;
        }

        channel.publish("message", { text: messageInput, user: email, username: username });
        document.getElementById("messageInput").value = "";
    }

    function handleMuteCommand(message) {
        const email = sessionStorage.getItem("userEmail");
        if (!email || (!modEmails.includes(email) && !devEmails.includes(email) && email !== headDevEmail)) {
            alert("You do not have permission to mute users.");
            return;
        }

        const emailToMute = message.split(" ")[1];
        if (!emailToMute) {
            alert("Usage: /mute <email>");
            return;
        }

        mutedUsers[emailToMute] = true;
        channel.publish("mute", { user: emailToMute });
    }

    function handleUnmuteCommand(message) {
        const email = sessionStorage.getItem("userEmail");
        if (!email || (!modEmails.includes(email) && !devEmails.includes(email) && email !== headDevEmail)) {
            alert("You do not have permission to unmute users.");
            return;
        }

        const emailToUnmute = message.split(" ")[1];
        if (!emailToUnmute) {
            alert("Usage: /unmute <email>");
            return;
        }

        delete mutedUsers[emailToUnmute];
        channel.publish("unmute", { user: emailToUnmute });
    }

    function loadMessages() {
        channel.subscribe("message", (message) => {
            const data = message.data;
            if (mutedUsers[data.user]) return;

            const chatBox = document.getElementById("chatBox");
            const messageElement = document.createElement("p");

            let extraStyle = "";
            let roleTag = "";
            let displayName = `<strong>${data.username}</strong>`;

            if (data.user === headDevEmail) {
                extraStyle = "color: blue;";
                roleTag = " <strong>[HEAD DEV]</strong>";
                displayName = `<img src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT1kbao_Z3IGQd8wH5dFu4F73HeBWm4d-N3GQ&s' width='20' height='20'> <strong>${data.username}</strong>`;
            } else if (devEmails.includes(data.user)) {
                extraStyle = "color: red;";
                roleTag = " <strong>[DEV]</strong>";
            } else if (modEmails.includes(data.user)) {
                extraStyle = "color: yellow;";
                roleTag = " <strong>[MOD]</strong>";
            }

            messageElement.innerHTML = `<span style='${extraStyle}'>${displayName}${roleTag}:</span> ${data.text}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        channel.subscribe("mute", (message) => {
            mutedUsers[message.data.user] = true;
        });

        channel.subscribe("unmute", (message) => {
            delete mutedUsers[message.data.user];
        });
    }

    window.onload = loadMessages;
</script>

</body>
</html>
