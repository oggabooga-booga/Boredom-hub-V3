<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/8595/8595483.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boredom Hub - Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" target="_blank">Home</a>
        <a href="games.html" target="_blank">Games</a>
        <a href="about.html" target="_blank">About Us</a>
        <a href="contact.html" target="_blank">Contact</a>   
        <a href="chat.html" target="_blank">Chat</a>
        <a href="rabbitAI.html" target="_blank">rabbitAI calculator</a>
    </div>
    <div class="content">
        <h2>Chat Room</h2>
        <p id="authStatus">Not logged in</p>
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()">Sign Out</button>
        <br><br>
        <input type="text" id="usernameInput" placeholder="Enter Username">
        <input type="text" id="messageInput" placeholder="Type a message" onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
        <br><br>

        <!-- Add Sigma Rank GIF Section -->
        <div id="sigmaBanner" style="display: none; background-color: green; padding: 10px; color: white;">
            <strong>Sigma Rank: Choose a GIF to add to the chat</strong>
            <select id="gifSelect">
                <option value="">Select a GIF</option>
                <option value="https://media.giphy.com/media/3o6Zt4t01d6gDmfVhW/giphy.gif">Dancing</option>
                <option value="https://media.giphy.com/media/3o85xJQXqf7LM4gfZC/giphy.gif">Excited</option>
                <option value="https://media.giphy.com/media/26AOhxPA0XEmrszTI/giphy.gif">Laughing</option>
            </select>
            <button onclick="sendGif()">Send GIF</button>
        </div>

        <div id="chatBox" class="chat-box" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

<script>
    const ably = new Ably.Realtime("mGqA8g.tKm8cg:BXet5NQMtxfr8k8I4Ls0MEzeQxmsQHihc80xDsYd-Ko");
    const channel = ably.channels.get("chat-room");

    let mutedUsers = JSON.parse(localStorage.getItem("mutedUsers")) || {}; 
    const modEmails = ["872654@dpsk12.net", "878197@dpsk12.net", "871341@dpsk12.net"]; 
    const devEmails = ["856030@dpsk12.net", "866537@dpsk12.net", "871491@dpsk12.net"]; 
    const sigmaEmails = ["sigma1@example.com", "sigma2@example.com"]; // Add Sigma emails here

    function loadMessages() {
        channel.subscribe("message", (message) => {
            const data = message.data;
            const chatBox = document.getElementById("chatBox");

            if (mutedUsers[data.user] && Date.now() < mutedUsers[data.user]) {
                console.log(`Blocked message from muted user: ${data.user}`);
                return;
            }

            const messageElement = document.createElement("p");
            let extraStyle = "";
            let roleTag = "";
            let email = sessionStorage.getItem("userEmail");
            let isPrivileged = modEmails.includes(email) || devEmails.includes(email);

            if (modEmails.includes(data.user)) {
                extraStyle = "color: yellow;";
                roleTag = " <strong>[MOD]</strong>";
            } else if (data.user === "856030@dpsk12.net") {
                extraStyle = "color: red;";
                roleTag = " <strong>[HEAD DEV]</strong>";
            } else if (devEmails.includes(data.user)) {
                extraStyle = "color: red;";
                roleTag = " <strong>[DEV]</strong>";
            } else if (sigmaEmails.includes(data.user)) {
                extraStyle = "color: green;";
                roleTag = " <strong>[SIGMA]</strong>";
                // Show the Sigma GIF selection banner
                document.getElementById("sigmaBanner").style.display = "block";
            }

            let userText = `<strong style="${extraStyle}">${data.username}${roleTag}:</strong> ${data.text}`;
            if (isPrivileged) {
                userText = `<strong style="${extraStyle}">${data.username} (${data.user})${roleTag}:</strong> ${data.text}`;
            }

            messageElement.innerHTML = userText;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;
        const username = sessionStorage.getItem("username");
        const userEmail = sessionStorage.getItem("userEmail");

        if (username && message) {
            channel.publish("message", {
                username,
                user: userEmail,
                text: message
            });
        }
        messageInput.value = '';
    }

    function sendGif() {
        const gifUrl = document.getElementById("gifSelect").value;
        if (gifUrl) {
            channel.publish("message", {
                username: sessionStorage.getItem("username"),
                user: sessionStorage.getItem("userEmail"),
                text: `<img src="${gifUrl}" alt="GIF">`
            });
        }
    }

    window.onload = () => {
        const email = sessionStorage.getItem("userEmail");
        if (email) {
            document.getElementById("authStatus").innerText = `Logged in as ${sessionStorage.getItem("username")}`;
        }
        loadMessages();
    };
</script>

</body>
</html>
