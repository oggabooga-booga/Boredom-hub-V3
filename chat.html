<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/8595/8595483.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boredom Hub - Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
    <div class="sidebar">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="about.html">About Us</a>
        <a href="contact.html">Contact</a>   
        <a href="chat.html">Chat</a>
        <a href="rabbitAI.html">rabbitAI calculator</a>
    </div>
    <div class="content">
        <h2>Chat Room</h2>
        <p id="authStatus">Not logged in</p>
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()">Sign Out</button>
        <br><br>
        <input type="text" id="usernameInput" placeholder="Enter Username">
        <input type="text" id="messageInput" placeholder="Type a message" onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
        <div id="chatBox" class="chat-box" style="max-height: 400px; overflow-y: auto;"></div>
        <div id="imageOverlay" class="image-overlay" style="display: none;"></div>
    </div>

<script>
    const ably = new Ably.Realtime("mGqA8g.tKm8cg:BXet5NQMtxfr8k8I4Ls0MEzeQxmsQHihc80xDsYd-Ko");
    const channel = ably.channels.get("chat-room");

    let mutedUsers = {};
    const modEmails = ["872654@dpsk12.net", "878197@dpsk12.net", "871341@dpsk12.net"];
    const devEmails = ["856030@dpsk12.net", "866537@dpsk12.net", "871491@dpsk12.net"];

    function signIn() {
        const email = prompt("Enter your email:");
        const username = prompt("Enter your username:");
        if (!email || !username) {
            alert("Email and username are required!");
            return;
        }
        sessionStorage.setItem("userEmail", email);
        sessionStorage.setItem("username", username);
        document.getElementById("authStatus").innerText = `Logged in as ${email}`;
    }

    function signOut() {
        sessionStorage.removeItem("userEmail");
        sessionStorage.removeItem("username");
        document.getElementById("authStatus").innerText = "Not logged in";
    }

    function sendMessage() {
        const messageInput = document.getElementById("messageInput").value.trim();
        const email = sessionStorage.getItem("userEmail");
        const username = sessionStorage.getItem("username");

        if (!email || !username) {
            alert("You must be signed in to send messages.");
            return;
        }

        if (mutedUsers[email]) {
            alert("You are muted and cannot send messages.");
            return;
        }

        if (messageInput.startsWith("/image")) {
            handleImageCommand(messageInput);
            return;
        }

        channel.publish("message", { text: messageInput, user: email, username: username });
        document.getElementById("messageInput").value = "";
    }

    function handleKeyPress(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    }

    function handleImageCommand(message) {
        const email = sessionStorage.getItem("userEmail");
        if (!email || (!modEmails.includes(email) && !devEmails.includes(email))) {
            alert("You do not have permission to use this command.");
            return;
        }

        const messageParts = message.split(" ");
        if (messageParts.length < 2) {
            alert("Usage: /image <image_url>");
            return;
        }

        const imageUrl = messageParts[1];
        showImageOverlay(imageUrl);
    }

    function showImageOverlay(imageUrl) {
        const overlay = document.getElementById("imageOverlay");
        overlay.style.display = "block";
        overlay.style.backgroundImage = `url(${imageUrl})`;
        setTimeout(() => { overlay.style.display = "none"; }, 5000);
    }

    function loadMessages() {
        channel.subscribe("message", (message) => {
            const data = message.data;
            const chatBox = document.getElementById("chatBox");
            if (mutedUsers[data.user]) return;

            const messageElement = document.createElement("p");
            let extraStyle = "";
            let roleTag = "";
            if (modEmails.includes(data.user)) {
                extraStyle = "color: yellow;";
                roleTag = " <strong>[MOD]</strong>";
            } else if (devEmails.includes(data.user)) {
                extraStyle = "color: red;";
                roleTag = " <strong>[DEV]</strong>";
            } else if (data.user === "819113@dpsk12.net") {
                extraStyle = "color: green;";
                roleTag = " <strong>[SIGMA]</strong>";
            }

            messageElement.innerHTML = `<strong style="${extraStyle}">${data.username} (${data.user})${roleTag}:</strong> ${data.text}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    window.onload = () => {
        const email = sessionStorage.getItem("userEmail");
        if (email) {
            document.getElementById("authStatus").innerText = `Logged in as ${email}`;
        }
        loadMessages();
    };
</script>

<style>
    .image-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background-size: cover;
        background-position: center;
        z-index: 9999;
    }
</style>

</body>
</html>

